<?php

namespace App\Console\Commands;

use App\Models\League;
use App\Models\Team;
use GuzzleHttp\Client;
use Illuminate\Console\Command;
use Illuminate\Support\Str;

class GetTeams extends Command
{
    /**
     * The name and signature of the console command.
     *
     * @var string
     */
    protected $signature = 'app:getTeams';

    /**
     * The console command description.
     *
     * @var string
     */
    protected $description = 'Fetch and update teams from external source';

    /**
     * Create a new command instance.
     *
     * @return void
     */
    public function __construct()
    {
        parent::__construct();
    }

    /**
     * Execute the console command.
     *
     * @return int
     */
    public function handle()
    {
        $this->getTeams();
    }

    /**
     * Fetch and process leagues and teams.
     */
    public function getTeams()
    {
        $ids = [
            84,
            923,
            75,
            650,
            648,
            652,
            651,
            653,
            88,
            649,
            892,
            304,
            44,
            185,
            388,
            76,
            222,
            434,
            387,
            261,
            609,
            730,
            768,
            1252,
            349,
            329,
            41,
            300,
            845,
            1180,
            1181,
            1294,
            1336,
            1322,
            1299,
            1489,
            1726,
            1861,
            2042,
            2043,
            1366,
            1223,
            1218,
            2341,
            2348,
            2497,
            2595,
            1315,
            1310,
            1307,
            1280,
            1679,
            1244,
            1229,
            1219,
            2401,
            67,
            103,
            113,
            1864,
            2187,
            109,
            223,
            114,
            1164,
            215,
            210,
            534,
            256,
            498,
            382,
            526,
            668,
            561,
            690,
            697,
            605,
            741,
            617,
            418,
            608,
            147,
            755,
            806,
            834,
            836,
            844,
            875,
            1178,
            1327,
            1306,
            1469,
            1813,
            1856,
            1944,
            79,
            1230,
            1225,
            2499,
            2503,
            2576,
            90,
            85,
            144,
            177,
            207,
            385,
            586,
            452,
            585,
            1209,
            1329,
            1617,
            2604,
            83,
            252,
            346,
            264,
            219,
            736,
            81,
            704,
            684,
            1126,
            51,
            529,
            462,
            842,
            1151,
            1312,
            54,
            55,
            698,
            70,
            505,
            69,
            2350,
            78,
            77,
            145,
            59,
            58,
            108,
            110,
            73,
            625,
            464,
            226,
            189,
            64,
            508,
            775,
            786,
            378,
            50,
            540,
            1426,
            96,
            74,
            231,
            195,
            200,
            365,
            501,
            757,
            153,
            191,
            1739,
            115,
            402,
            491,
            154,
            485,
            116,
            1080,
            163,
            197,
            494,
            1351,
            143,
            654,
            246,
            773,
            1009,
            1074,
            1132,
            1148,
            1334,
            1849,
            1869,
            1438,
            1439,
            243,
            2531,
            205,
            711,
            858,
            1821,
            2586,
            638,
            558,
            167,
            705,
            1236,
            190,
            518,
            155,
            249,
            513,
            62,
            196,
            496,
            208,
            688,
            168,
            710,
            211,
            634,
            527,
            2557,
            355,
            646,
            1437,
            549,
            794,
            639,
            701,
            657,
            1285,
            1328,
            1050,
            647,
            620,
            569,
            1717,
            2400,
            1362,
            1224,
            224,
            89,
            232,
            263,
            344,
            424,
            270,
            175,
            489,
            487,
            213,
            429,
            621,
            188,
            679,
            682,
            691,
            734,
            673,
            889,
            1121,
            1123,
            1167,
            1171,
            1211,
            1177,
            1212,
            1289,
            1290,
            1282,
            1808,
            1907,
            1964,
            1968,
            2056,
            2059,
            2088,
            2089,
            2482,
            2250,
            1368,
            1371,
            1345,
            974,
            2481,
            2505,
            2585,
            483,
            1740,
            1876,
            2117,
            186,
            751,
            930,
            1065,
            1358,
            1441,
            1448,
            1719,
            1937,
            2216,
            1275,
            1602,
            340,
            1277,
            2016,
            1183,
            2304,
            714,
            1309,
            173,
            1807,
            2119,
            1350,
            1970,
            1162,
            1231,
            2383,
            635,
            1349,
            1184,
            1484,
            1352,
            1308,
            664,
            95,
            192,
            251,
            53,
            979,
            291,
            293,
            1124,
            470,
            1044,
            655,
            220,
            187,
            182,
            161,
            401,
            405,
            515,
            432,
            307,
            560,
            420,
            851,
            477,
            600,
            571,
            629,
            725,
            992,
            731,
            396,
            564,
            1331,
            798,
            1136,
            295,
            435,
            689,
            516,
            1253,
            699,
            399,
            726,
            1444,
            1625,
            1638,
            1725,
            1981,
            1985,
            2047,
            2077,
            1403,
            1404,
            1370,
            503,
            1254,
            1220,
            1385,
            1408,
            2319,
            2385,
            2402,
            2409,
            2437,
            2471,
            2581,
            2594,
            1278,
            1303,
            831,
            1320,
            1321,
            86,
            87,
            202,
            796,
            735,
            1286,
            420,
            458,
            631,
            499,
            413,
            610,
            1690,
            1699,
            1811,
            1843,
            2013,
            2370,
            2474,
            2528,
            695,
            393,
            72,
            71,
            162,
            517,
            525,
            574,
            1581,
            1731,
            1795,
            685,
            468,
            437,
            383,
            612,
            977,
            978,
            1064,
            1075,
            1135,
            1301,
            1356,
            1672,
            1845,
            2434,
            891,
            640,
            339,
            884,
            1359,
            618,
            1488,
            331,
            733,
            245,
            603,
            280,
            426,
            822,
            1963,
            1187,
            721,
            747,
            839,
            1914,
            450,
            1028,
            1031,
            1102,
            2224,
            1058,
            330,
            587,
            758,
            882,
            1119,
            2513,
            471,
            559,
            592,
            1008,
            925,
            1318,
            823,
            1342,
            1383,
            474,
            1273,
            2473,
            937,
            1340,
            1197,
            1955,
            1265,
            1335,
            2004,
            1240,
            543,
            968,
            1025,
            1128,
            1149,
            1332,
            1806,
            1953,
            1965,
            1372,
            2534,
            2545,
            93,
            239,
            262,
            176,
            581,
            624,
            738,
            765,
            781,
            931,
            1051,
            1052,
            1133,
            1138,
            1333,
            1311,
            1297,
            1387,
            1666,
            1722,
            1812,
            2090,
            1226,
            1213,
            2615,
            779,
            1010,
            467,
            2589,
            636,
            333,
            451,
            2311,

            650,
            892,
            44,
            185,
            76,
            261,
            609,
            387,
            730,
            1252,
            222,
            434,
            1861,
            2042,
            2043,
            768,
            349,
            329,
            300,
            845,
            1180,
            1181,
            2595,
            1294,
            1322,
            1489,
            1726,
            1223,
            2497,
            648,
            651,
            653,
            88,
            649,
            1218,
            2348,
            1315,
            1310,
            1307,
            1280,
            1679,
            1244,
            1229,
            1219,
            2401,
            1361,
            1864,
            223,
            114,
            1164,
            215,
            210,
            256,
            526,
            668,
            561,
            690,
            605,
            741,
            608,
            836,
            875,
            1306,
            1230,
            2503,
            2576,
            2499,
            224,
            232,
            424,
            489,
            487,
            429,
            621,
            679,
            682,
            691,
            1121,
            1123,
            1171,
            1177,
            1212,
            1289,
            1282,
            1964,
            2059,
            2089,
            2482,
            1345,
            1368,
            251, 53, 291, 293, 1124, 470, 655, 161, 405,
            560, 571, 629, 725, 731, 564, 1331, 798, 295, 435,
            689, 516, 1253, 699, 399, 726, 1444, 1625, 1638,
            1403, 1404, 1370, 503, 1254, 1220, 1385, 1408,
            2319, 2385, 2402, 2409, 2471,2594,
            1128,
            1149,
            1332,
            1953,
            1965,
            2534,
            2545,
            93,
            176,
            581,
            624,
            781,
            931,
            1052,
            1052,
            1311,
            1297,
            1722,
            1812,
            1226,
            1213,
            2607,
            2615
        ];

        $leagues = League::whereNotIn('league_id', $ids)->get();

        // Progress bar for leagues
        $this->info('Fetching teams from leagues...');
        $leagueBar = $this->output->createProgressBar($leagues->count());
        $leagueBar->start();

        foreach ($leagues as $league) {
            $this->getTeamsData($league->league_id);
            $league = League::where('league_id', $league->league_id)->first();
            $league->update(['last_collect_time' => now()]);
            $leagueBar->advance(); // Advance the progress bar
        }

        $leagueBar->finish(); // Finish the progress bar
        $this->newLine(); // Add a newline after the progress bar
        $this->info('Team fetching completed successfully.');
    }

    /**
     * Fetch teams data for a league.
     *
     * @param int $leagueId
     */
    public function getTeamsData($leagueId)
    {
        try {
            $url = "https://football.nowgoal19.com/jsdata/teaminfo/team{$leagueId}.js?v=20240925052403";

            $client = new Client();
            $response = $client->request('GET', $url);
            $body = $response->getBody()->getContents();

            if (preg_match("/var\s+arrTeam\s*=\s*(\[\[.*?\]\]);/i", $body, $matches)) {
                $arrTeamString = $matches[1];

                $jsonString = preg_replace("/'/", '"', $arrTeamString);
                $arrTeam = explode('],', $arrTeamString);

                // Progress bar for teams
                $this->info("Fetching teams for league ID {$leagueId}...");
                $teamBar = $this->output->createProgressBar(count($arrTeam));
                $teamBar->start();

                foreach ($arrTeam as $team) {
                    $t = explode(',', $team);

                    // Şərti yoxlama
                    if (
                        !preg_match("/A1|B1|C1|G1|D1|H1|F1|Winner|Semifinal|WIN|OLSUN/i", $t[3]) &&
                        !preg_match("/\[\w{2}\]/", $t[3])
                    ) {
                        $findedTeam = Team::where("team_id", str_replace('[', '', $t[0]))->first();

                        $logo = str_replace(']]', '', str_replace("'", '', $t[5]));

                        // Şərt: Logo dəyəri mövcud və minimum uzunluğu 3-dürsə
                        if ($logo !== null && strlen($logo) >= 3) {
                            $logo = $logo; // Yalnız uyğun logonu saxla
                        } else {
                            $logo = null; // Logo uyğun deyilsə, boş saxla
                        }

                        $updateData = [
                            'team_id' => str_replace('[', '', $t[0]),
                            'league_id' => $leagueId,
                            'slug' => Str::slug(str_replace("'", '', $t[3])),
                            'team_name' => str_replace("'", '', $t[3]),
                            'team_type' => 2,
                            'logo' => $logo, // Yuxarıdakı şərtə uyğun logo əlavə olunur
                        ];

                        if ($findedTeam) {
                            $findedTeam->update($updateData);
                        } else {
                            Team::create($updateData);
                        }
                    }

                    $teamBar->advance();
                }

                $teamBar->finish();
                $this->newLine();
            }
        } catch (\Exception $e) {
            $this->error("Error fetching teams for league ID {$leagueId}: " . $e->getMessage());
        }
    }

}
